import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

import '../../../app/router/route_paths.dart';
import '../../../app/theme/design_tokens.dart';
import '../../../shared/providers/auth_provider.dart';
import '../../../shared/providers/words_provider.dart';
import '../../../shared/providers/favorites_provider.dart';
import '../../../shared/providers/locale_provider.dart';
import '../../../shared/models/word_model.dart';
import '../../../l10n/generated/l10n_simple.dart';
import '../../../core/services/audio_service.dart';
import 'package:flutter/foundation.dart';

/// å•è¯è¯¦æƒ…é¡µé¢
class WordDetailPage extends ConsumerStatefulWidget {
  const WordDetailPage({
    super.key,
    required this.wordId,
    this.searchQuery,
  });

  final int wordId;
  final String? searchQuery; // ç”¨æˆ·æœç´¢çš„æŸ¥è¯¢è¯

  @override
  ConsumerState<WordDetailPage> createState() => _WordDetailPageState();
}

class _WordDetailPageState extends ConsumerState<WordDetailPage> {
  final Map<int, bool> _phraseDialogExpanded = {};
  final AudioService _audioService = AudioService();

  @override
  void initState() {
    super.initState();
    // å¦‚æœæœ‰æœç´¢æŸ¥è¯¢è¯ï¼Œæ·»åŠ åˆ°æœç´¢å†å²
    if (widget.searchQuery != null && widget.searchQuery!.isNotEmpty) {
      _addSearchHistoryItem(widget.searchQuery!);
    }
  }

  @override
  Widget build(BuildContext context) {
    final wordAsync = ref.watch(wordByIdProvider(widget.wordId));

    // ç›‘å¬ locale å˜åŒ–ä»¥ç¡®ä¿é¡µé¢åœ¨è¯­è¨€åˆ‡æ¢æ—¶é‡å»º
    ref.watch(localeNotifierProvider);

    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
    if (kDebugMode) {
      print('ğŸ” æ„å»ºWordDetailPage, wordId: ${widget.wordId}');
      print('ğŸ” wordAsyncçŠ¶æ€: ${wordAsync.runtimeType}');
      wordAsync.when(
        data: (word) => print('ğŸ” wordAsyncæ•°æ®: ${word?.headWord}'),
        loading: () => print('ğŸ” wordAsyncåŠ è½½ä¸­'),
        error: (error, stack) => print('ğŸ” wordAsyncé”™è¯¯: $error'),
      );
    }

    return Scaffold(
      appBar: AppBar(
        title: Text(S.current.wordDetail),
        actions: [
          if (kDebugMode)
            IconButton(
              icon: const Icon(Icons.bug_report),
              onPressed: () {
                _debugAccessWord();
              },
            ),
        ],
      ),
      body: SafeArea(
        child: wordAsync.when(
          data: (word) {
            if (word == null) {
              return const Center(
                child: Text('æœªæ‰¾åˆ°è¯¥å•è¯'),
              );
            }
            // æ·»åŠ é¢å¤–çš„å®‰å…¨æ£€æŸ¥
            if (word.headWord.isEmpty) {
              return const Center(
                child: Text('å•è¯æ•°æ®ä¸å®Œæ•´'),
              );
            }
            return _buildSafeWordContent(word);
          },
          loading: () => const Center(
            child: CircularProgressIndicator(),
          ),
          error: (error, stackTrace) => Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Icon(
                  Icons.error_outline,
                  size: 48,
                  color: Colors.grey,
                ),
                const SizedBox(height: 16),
                Text('åŠ è½½å¤±è´¥: ${error.toString()}'),
                const SizedBox(height: 16),
                ElevatedButton(
                  onPressed: () => ref.refresh(wordByIdProvider(widget.wordId)),
                  child: const Text('é‡è¯•'),
                ),
                if (kDebugMode) ...[
                  const SizedBox(height: 8),
                  Text(
                    'é”™è¯¯è¯¦æƒ…: ${stackTrace.toString()}',
                    style: const TextStyle(fontSize: 10, color: Colors.grey),
                  ),
                ],
              ],
            ),
          ),
        ),
      ),
    );
  }

  /// å®‰å…¨æ„å»ºå•è¯å†…å®¹ï¼Œå¸¦æœ‰é”™è¯¯å¤„ç†
  Widget _buildSafeWordContent(WordModel word) {
    // ä½¿ç”¨Builderç¡®ä¿æ­£ç¡®çš„ä¸Šä¸‹æ–‡
    return Builder(
      builder: (context) {
        try {
          // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
          if (kDebugMode) {
            print('ğŸ” _buildSafeWordContent å¼€å§‹æ„å»º: ${word.headWord}');
            print('   - ID: ${word.id}');
            print('   - wordId: ${word.wordId}');
            print('   - bookId: ${word.bookId}');
            print('   - wordRank: ${word.wordRank}');
            print('   - headWord: ${word.headWord}');
            print('   - usphone: ${word.usphone}');
            print('   - ukphone: ${word.ukphone}');
            print('   - transæ•°é‡: ${word.trans.length}');
            print('   - sentencesæ•°é‡: ${word.sentences.length}');
            print('   - phrasesæ•°é‡: ${word.phrases.length}');
          }

          // éªŒè¯åŸºæœ¬æ•°æ®
          if (word.headWord == null || word.headWord.isEmpty) {
            print('âŒ headWordéªŒè¯å¤±è´¥: ${word.headWord}');
            return _buildErrorWidget('å•è¯æ•°æ®æ— æ•ˆ', 'headWordä¸ºç©ºæˆ–null');
          }

          // å»¶è¿Ÿæ¸²æŸ“å¤æ‚å†…å®¹ï¼Œå…ˆæ¸²æŸ“åŸºç¡€ç»“æ„
          return FutureBuilder(
            future: Future.delayed(const Duration(milliseconds: 100)),
            builder: (context, snapshot) {
              if (snapshot.connectionState != ConnectionState.done) {
                return _buildLoadingWidget('æ­£åœ¨åŠ è½½å•è¯è¯¦æƒ…...');
              }

              // ç›´æ¥æ„å»ºå†…å®¹ï¼Œé¿å…å¤æ‚çš„å¼‚æ­¥æ¸²æŸ“é—®é¢˜
              return _buildWordContent(word);
            },
          );
        } catch (e, stackTrace) {
          print('âŒ æ„å»ºå•è¯å†…å®¹æ—¶å‡ºé”™: $e');
          if (kDebugMode) {
            print('å †æ ˆè·Ÿè¸ª: $stackTrace');
          }

          // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
          if (mounted) {
            WidgetsBinding.instance.addPostFrameCallback((_) {
              if (mounted) {
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text('é¡µé¢æ¸²æŸ“å‡ºç°é—®é¢˜ï¼Œæ˜¾ç¤ºç®€åŒ–ç‰ˆæœ¬'),
                    duration: const Duration(seconds: 2),
                    backgroundColor: Colors.orange,
                    action: SnackBarAction(
                      label: 'è¯¦æƒ…',
                      onPressed: () {
                        _showErrorDialog(context, e.toString());
                      },
                    ),
                  ),
                );
              }
            });
          }

          return _buildFallbackWordContent(word);
        }
      },
    );
  }

  /// æ„å»ºå•è¯å†…å®¹
  Widget _buildWordContent(WordModel word) {
    return SingleChildScrollView(
      child: Container(
        constraints: BoxConstraints(
          minHeight: 400, // è®¾ç½®ä¸€ä¸ªå›ºå®šçš„æœ€å°é«˜åº¦
        ),
        padding: const EdgeInsets.all(DesignTokens.spacingMedium),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          mainAxisSize: MainAxisSize.min, // ç¡®ä¿Columnåªå ç”¨éœ€è¦çš„ç©ºé—´
          children: [
            // å•è¯å¤´éƒ¨ï¼šå•è¯ã€éŸ³æ ‡ã€æ”¶è—æŒ‰é’®
            _buildWordHeader(word),

          const SizedBox(height: DesignTokens.spacingLarge),

          // åˆ†ç±»å’Œæ’åä¿¡æ¯
          _buildWordMeta(word),

          const SizedBox(height: DesignTokens.spacingLarge),

          // è¯æ€§é‡Šä¹‰
          _buildTransSection(word),

          const SizedBox(height: DesignTokens.spacingLarge),

          // ä¾‹å¥
          if (word.sentences.isNotEmpty) ...[
            _buildSentencesSection(word),
            const SizedBox(height: DesignTokens.spacingLarge),
          ],

          // çŸ­è¯­
          if (word.phrases.isNotEmpty) ...[
            _buildPhrasesSection(word),
            const SizedBox(height: DesignTokens.spacingLarge),
          ],

          // åŒè¿‘ä¹‰è¯
          if (word.synonyms.isNotEmpty) ...[
            _buildSynonymsSection(word),
            const SizedBox(height: DesignTokens.spacingLarge),
          ],

          // åŒæ ¹è¯
          if (word.relWords.isNotEmpty) ...[
            _buildRelWordsSection(word),
            const SizedBox(height: DesignTokens.spacingLarge),
          ],

          // è€ƒè¯•é¢˜ç›®
          if (word.exams.isNotEmpty) ...[
            _buildExamsSection(word),
          ],
        ],
      ),
    );
  }
  }

  /// æ„å»ºå•è¯å¤´éƒ¨ä¿¡æ¯
  Widget _buildWordHeader(WordModel word) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(DesignTokens.spacingLarge),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // å•è¯æœ¬èº«
                  Text(
                    word.headWord ?? 'æœªçŸ¥å•è¯',
                    style: Theme.of(context).textTheme.headlineMedium?.copyWith(
                      fontWeight: FontWeight.bold,
                      color: Theme.of(context).colorScheme.primary,
                    ),
                  ),
                  const SizedBox(height: DesignTokens.spacingSmall),

                  // éŸ³æ ‡
                  if (word.usPhone != null || word.ukPhone != null) ...[
                    Row(
                      children: [
                        if (word.usPhone != null) ...[
                          const Text('ç¾éŸ³: ', style: TextStyle(fontSize: 12)),
                          Text(word.usPhone!, style: const TextStyle(fontSize: 12)),
                          const SizedBox(width: 8),
                          // ç¾éŸ³æ’­æ”¾æŒ‰é’®
                          SizedBox(
                            width: 24,
                            height: 24,
                            child: Material(
                              color: Colors.transparent,
                              child: InkWell(
                                onTap: () => _playPronunciation(word.headWord, 'us'),
                                borderRadius: BorderRadius.circular(12),
                                child: const Icon(
                                  Icons.volume_up,
                                  size: 16,
                                  color: Colors.blue,
                                ),
                              ),
                            ),
                          ),
                          const SizedBox(width: 16),
                        ],
                        if (word.ukPhone != null) ...[
                          const Text('è‹±éŸ³: ', style: TextStyle(fontSize: 12)),
                          Text(word.ukPhone!, style: const TextStyle(fontSize: 12)),
                          const SizedBox(width: 8),
                          // è‹±éŸ³æ’­æ”¾æŒ‰é’®
                          SizedBox(
                            width: 24,
                            height: 24,
                            child: Material(
                              color: Colors.transparent,
                              child: InkWell(
                                onTap: () => _playPronunciation(word.headWord, 'uk'),
                                borderRadius: BorderRadius.circular(12),
                                child: const Icon(
                                  Icons.volume_up,
                                  size: 16,
                                  color: Colors.blue,
                                ),
                              ),
                            ),
                          ),
                        ],
                      ],
                    ),
                    const SizedBox(height: DesignTokens.spacingSmall),
                  ],
                ],
              ),
            ),

            // æ”¶è—æŒ‰é’®
            _buildFavoriteButton(word),
          ],
        ),
      ),
    );
  }

  /// æ„å»ºå•è¯å…ƒä¿¡æ¯
  Widget _buildWordMeta(WordModel word) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(DesignTokens.spacingMedium),
        child: Row(
          children: [
            // ä¹¦ç±ID/åˆ†ç±»
            Chip(
              label: Text(
                _getCategoryName(word.bookId),
                style: const TextStyle(fontSize: 12),
              ),
              backgroundColor: Theme.of(context).colorScheme.primaryContainer,
            ),
            const SizedBox(width: DesignTokens.spacingSmall),

            // æ’å
            Chip(
              label: Text(
                'æ’å: ${word.wordRank}',
                style: const TextStyle(fontSize: 12),
              ),
              backgroundColor: Theme.of(context).colorScheme.secondaryContainer,
            ),
          ],
        ),
      ),
    );
  }

  /// ä»bookIdè·å–åˆ†ç±»åç§°
  String _getCategoryName(String bookId) {
    if (bookId.contains('CET4')) return 'CET4';
    if (bookId.contains('CET6')) return 'CET6';
    if (bookId.contains('è€ƒç ”') || bookId.contains('KAUYAN')) return 'è€ƒç ”';
    if (bookId.contains('IELTS')) return 'é›…æ€';
    if (bookId.contains('TOEFL')) return 'æ‰˜ç¦';
    if (bookId.contains('GRE')) return 'GRE';
    return bookId;
  }

  /// æ„å»ºé‡Šä¹‰éƒ¨åˆ†
  Widget _buildTransSection(WordModel word) {
    if (word.trans.isEmpty) {
      return const SizedBox.shrink();
    }

    return Card(
      child: Padding(
        padding: const EdgeInsets.all(DesignTokens.spacingLarge),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'è¯æ€§é‡Šä¹‰',
              style: Theme.of(context).textTheme.titleLarge?.copyWith(
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: DesignTokens.spacingMedium),
            ...word.trans.map((trans) => Padding(
              padding: const EdgeInsets.only(bottom: DesignTokens.spacingMedium),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: Theme.of(context).colorScheme.primaryContainer,
                          borderRadius: BorderRadius.circular(4),
                        ),
                        child: Text(trans.pos),
                      ),
                    ],
                  ),
                  const SizedBox(height: DesignTokens.spacingSmall),
                  Text(
                    trans.tranCn,
                    style: Theme.of(context).textTheme.bodyLarge,
                  ),
                  if (trans.tranOther != null && trans.tranOther!.isNotEmpty) ...[
                    const SizedBox(height: DesignTokens.spacingSmall),
                    Text(
                      trans.tranOther!,
                      style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                        color: Theme.of(context).colorScheme.onSurfaceVariant,
                        fontStyle: FontStyle.italic,
                      ),
                    ),
                  ],
                ],
              ),
            )),
          ],
        ),
      ),
    );
  }

  /// æ„å»ºä¾‹å¥éƒ¨åˆ†
  Widget _buildSentencesSection(WordModel word) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(DesignTokens.spacingLarge),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'ä¾‹å¥',
              style: Theme.of(context).textTheme.titleLarge?.copyWith(
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: DesignTokens.spacingMedium),
            ...word.sentences.map((sentence) => Padding(
              padding: const EdgeInsets.only(bottom: DesignTokens.spacingMedium),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    sentence.sContent,
                    style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                      fontStyle: FontStyle.italic,
                    ),
                  ),
                  const SizedBox(height: DesignTokens.spacingSmall),
                  Text(
                    sentence.sCn,
                    style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                      color: Theme.of(context).colorScheme.onSurfaceVariant,
                    ),
                  ),
                ],
              ),
            )),
          ],
        ),
      ),
    );
  }

  /// æ„å»ºå‘éŸ³åŒºåŸŸ (å·²ç§»é™¤ï¼ŒéŸ³æ ‡ä¿¡æ¯åœ¨å¤´éƒ¨æ˜¾ç¤º)
  Widget _buildPronunciationSection(WordModel word) {
    return const SizedBox.shrink();
  }

  /// æ„å»ºå†…å®¹åŒºåŸŸï¼ˆå·²ç§»é™¤ï¼Œç›´æ¥åœ¨ä¸»æ„å»ºæ–¹æ³•ä¸­å¤„ç†ï¼‰
  Widget _buildContentSection(WordModel word) {
    return const SizedBox.shrink();
  }

  /// æ„å»ºä¾‹å¥åŒºåŸŸ
  Widget _buildExamplesSection(WordModel word) {
    if (word.sentences.isEmpty) {
      return const SizedBox.shrink();
    }

    return Card(
      child: Column(
        children: [
          ListTile(
            leading: Icon(
              Icons.format_quote,
              color: Theme.of(context).colorScheme.primary,
            ),
            title: const Text('ä¾‹å¥'),
          ),
          
          const Divider(height: 1),
          
          ...word.sentences.asMap().entries.map((entry) {
            final index = entry.key;
            final sentence = entry.value;
            return _buildSentenceItem(word, index + 1, sentence);
          }),
        ],
      ),
    );
  }

  /// æ„å»ºä¾‹å¥é¡¹
  Widget _buildSentenceItem(WordModel word, int index, KajSentence sentence) {
    return Column(
      children: [
        Container(
          width: double.infinity,
          padding: const EdgeInsets.all(DesignTokens.spacingMedium),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // ç¼–å·
              Text(
                '$index.',
                style: Theme.of(context).textTheme.labelSmall?.copyWith(
                  color: Theme.of(context).colorScheme.primary,
                  fontWeight: FontWeight.bold,
                ),
              ),
              const SizedBox(height: 4),
              
              // è‹±æ–‡ä¾‹å¥
              Text(
                sentence.sContent,
                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                  fontStyle: FontStyle.italic,
                ),
              ),
              const SizedBox(height: 4),
              
              // ä¸­æ–‡ç¿»è¯‘
              Text(
                sentence.sCn,
                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                  color: Theme.of(context).colorScheme.onSurfaceVariant,
                ),
              ),
            ],
          ),
        ),
        
        // åˆ†å‰²çº¿ï¼ˆæœ€åä¸€é¡¹é™¤å¤–ï¼‰
        if (index < word.sentences.length) const Divider(height: 1),
      ],
    );
  }

  /// æ„å»ºæ”¶è—æŒ‰é’®
  Widget _buildFavoriteButton(WordModel word) {
    final isAuthenticated = ref.watch(isAuthenticatedProvider);

    if (!isAuthenticated) {
      return SizedBox(
        width: 40,
        height: 40,
        child: IconButton(
          icon: const Icon(Icons.favorite_border, size: 24),
          onPressed: () => _showLoginRequiredDialog(),
          padding: EdgeInsets.zero,
          visualDensity: VisualDensity.compact,
        ),
      );
    }

    // ç”¨æˆ·å·²ç™»å½•ï¼Œæ˜¾ç¤ºçœŸå®çš„æ”¶è—çŠ¶æ€
    final favoriteToggleAsync = ref.watch(favoriteToggleProvider(word.id));

    return favoriteToggleAsync.when(
      data: (isFavorited) => SizedBox(
        width: 40,
        height: 40,
        child: IconButton(
          icon: Icon(
            isFavorited ? Icons.favorite : Icons.favorite_border,
            size: 24,
            color: isFavorited ? Colors.red : null,
          ),
          onPressed: () => _toggleFavorite(word),
          padding: EdgeInsets.zero,
          visualDensity: VisualDensity.compact,
        ),
      ),
      loading: () => const Padding(
        padding: EdgeInsets.all(12.0),
        child: SizedBox(
          width: 16,
          height: 16,
          child: CircularProgressIndicator(strokeWidth: 2),
        ),
      ),
      error: (error, stack) => SizedBox(
        width: 40,
        height: 40,
        child: IconButton(
          icon: const Icon(Icons.favorite_border, size: 24),
          onPressed: () => _toggleFavorite(word),
          padding: EdgeInsets.zero,
          visualDensity: VisualDensity.compact,
        ),
      ),
    );
  }

  /// åˆ‡æ¢æ”¶è—çŠ¶æ€
  void _toggleFavorite(WordModel word) async {
    final isAuthenticated = ref.read(isAuthenticatedProvider);
    
    if (!isAuthenticated) {
      _showLoginRequiredDialog();
      return;
    }

    try {
      final toggleNotifier = ref.read(favoriteToggleProvider(word.id).notifier);
      final newState = await toggleNotifier.toggle();
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(newState ? 'å·²æ·»åŠ åˆ°æ”¶è—' : 'å·²ä»æ”¶è—ä¸­ç§»é™¤'),
            duration: const Duration(seconds: 1),
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('æ“ä½œå¤±è´¥: $e'),
            duration: const Duration(seconds: 2),
          ),
        );
      }
    }
  }

  /// æ˜¾ç¤ºéœ€è¦ç™»å½•çš„æç¤ºå¯¹è¯æ¡†
  void _showLoginRequiredDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('éœ€è¦ç™»å½•'),
        content: const Text('æ”¶è—å•è¯éœ€è¦ç™»å½•è´¦æˆ·ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('å–æ¶ˆ'),
          ),
          TextButton(
            onPressed: () {
              Navigator.of(context).pop();
              context.push(RoutePaths.login);
            },
            child: const Text('å»ç™»å½•'),
          ),
        ],
      ),
    );
  }

  /// æ·»åŠ æœç´¢å†å²é¡¹
  void _addSearchHistoryItem(String word) async {
    try {
      // è·å–ç°æœ‰çš„æœç´¢å†å²
      final prefs = await SharedPreferences.getInstance();
      final historyJson = prefs.getString('search_history');
      List<String> searchHistory = [];
      
      if (historyJson != null) {
        final List<dynamic> historyList = jsonDecode(historyJson);
        searchHistory = historyList.cast<String>();
      }
      
      // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
      searchHistory.remove(word);
      // æ·»åŠ åˆ°å¼€å¤´
      searchHistory.insert(0, word);
      // é™åˆ¶æœ€å¤§æ•°é‡ä¸º30ä¸ª
      if (searchHistory.length > 30) {
        searchHistory = searchHistory.take(30).toList();
      }
      
      // ä¿å­˜åˆ°SharedPreferences
      final newHistoryJson = jsonEncode(searchHistory);
      await prefs.setString('search_history', newHistoryJson);
    } catch (e) {
      // å¦‚æœä¿å­˜å¤±è´¥ï¼Œé™é»˜å¤„ç†
      debugPrint('ä¿å­˜æœç´¢å†å²å¤±è´¥: $e');
    }
  }

  /// æ„å»ºçŸ­è¯­éƒ¨åˆ†
  Widget _buildPhrasesSection(WordModel word) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(DesignTokens.spacingLarge),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'çŸ­è¯­',
              style: Theme.of(context).textTheme.titleLarge?.copyWith(
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: DesignTokens.spacingMedium),
            ...word.phrases.map((phrase) => Padding(
              padding: const EdgeInsets.only(bottom: DesignTokens.spacingMedium),
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text('â€¢ ', style: TextStyle(fontWeight: FontWeight.bold)),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          phrase.pContent,
                          style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                            fontStyle: FontStyle.italic,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          phrase.pCn,
                          style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                            color: Theme.of(context).colorScheme.onSurfaceVariant,
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            )),
          ],
        ),
      ),
    );
  }

  /// æ„å»ºåŒè¿‘ä¹‰è¯éƒ¨åˆ†
  Widget _buildSynonymsSection(WordModel word) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(DesignTokens.spacingLarge),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'åŒè¿‘ä¹‰è¯',
              style: Theme.of(context).textTheme.titleLarge?.copyWith(
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: DesignTokens.spacingMedium),
            ...word.synonyms.map((syno) => Padding(
              padding: const EdgeInsets.only(bottom: DesignTokens.spacingMedium),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: Theme.of(context).colorScheme.secondaryContainer,
                          borderRadius: BorderRadius.circular(4),
                        ),
                        child: Text(syno.pos),
                      ),
                    ],
                  ),
                  const SizedBox(height: DesignTokens.spacingSmall),
                  Text(syno.tran),
                  if (syno.hwds.isNotEmpty) ...[
                    const SizedBox(height: DesignTokens.spacingSmall),
                    Text(
                      'è¿‘ä¹‰è¯: ${syno.hwds.map((hwd) => hwd.w).join(', ')}',
                      style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                        color: Theme.of(context).colorScheme.primary,
                      ),
                    ),
                  ],
                ],
              ),
            )),
          ],
        ),
      ),
    );
  }

  /// æ„å»ºåŒæ ¹è¯éƒ¨åˆ†
  Widget _buildRelWordsSection(WordModel word) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(DesignTokens.spacingLarge),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'åŒæ ¹è¯',
              style: Theme.of(context).textTheme.titleLarge?.copyWith(
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: DesignTokens.spacingMedium),
            ...word.relWords.map((relWord) => Padding(
              padding: const EdgeInsets.only(bottom: DesignTokens.spacingMedium),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: Theme.of(context).colorScheme.tertiaryContainer,
                          borderRadius: BorderRadius.circular(4),
                        ),
                        child: Text(relWord.pos),
                      ),
                    ],
                  ),
                  const SizedBox(height: DesignTokens.spacingSmall),
                  ...relWord.words.map((relatedWord) => Padding(
                    padding: const EdgeInsets.only(left: 16, top: 4),
                    child: Text(
                      '${relatedWord.hwd} - ${relatedWord.tran}',
                      style: Theme.of(context).textTheme.bodyMedium,
                    ),
                  )),
                ],
              ),
            )),
          ],
        ),
      ),
    );
  }

  /// æ„å»ºè€ƒè¯•é¢˜ç›®éƒ¨åˆ†
  Widget _buildExamsSection(WordModel word) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(DesignTokens.spacingLarge),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  'è€ƒè¯•é¢˜ç›®',
                  style: Theme.of(context).textTheme.titleLarge?.copyWith(
                    fontWeight: FontWeight.bold,
                  ),
                ),
                ElevatedButton.icon(
                  onPressed: () => _showExamDialog(word),
                  icon: const Icon(Icons.quiz, size: 16),
                  label: const Text('å¼€å§‹æµ‹è¯•', style: TextStyle(fontSize: 12)),
                ),
              ],
            ),
            const SizedBox(height: DesignTokens.spacingMedium),
            Text(
              'å…± ${word.exams.length} é“é¢˜ç›®',
              style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                color: Theme.of(context).colorScheme.onSurfaceVariant,
              ),
            ),
          ],
        ),
      ),
    );
  }

  /// æ˜¾ç¤ºè€ƒè¯•é¢˜ç›®å¯¹è¯æ¡†
  void _showExamDialog(WordModel word) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('è€ƒè¯•é¢˜ç›®'),
        content: const Text('è€ƒè¯•é¢˜ç›®åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('å…³é—­'),
          ),
        ],
      ),
    );
  }

  /// æ„å»ºç®€åŒ–çš„å•è¯å†…å®¹ï¼ˆä½œä¸ºfallbackï¼‰
  Widget _buildFallbackWordContent(WordModel word) {
    // ä½¿ç”¨LayoutBuilderç¡®ä¿æœ‰æ­£ç¡®çš„çº¦æŸ
    return LayoutBuilder(
      builder: (context, constraints) {
        return SingleChildScrollView(
          padding: const EdgeInsets.all(DesignTokens.spacingMedium),
          child: ConstrainedBox(
            constraints: BoxConstraints(
              minHeight: constraints.maxHeight - 100, // ç¡®ä¿æœ€å°é«˜åº¦
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisSize: MainAxisSize.min,
              children: [
                // ç®€åŒ–çš„å•è¯å¤´éƒ¨
                Card(
                  child: Padding(
                    padding: const EdgeInsets.all(DesignTokens.spacingMedium),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Text(
                          word.headWord,
                          style: Theme.of(context).textTheme.headlineMedium?.copyWith(
                            fontWeight: FontWeight.bold,
                            color: Theme.of(context).colorScheme.primary,
                          ),
                        ),
                        const SizedBox(height: 8),

                        // æ˜¾ç¤ºéŸ³æ ‡ä¿¡æ¯
                        if (word.usPhone != null || word.ukPhone != null) ...[
                          Wrap(
                            children: [
                              if (word.usPhone != null) ...[
                                const Text('ç¾éŸ³: ', style: TextStyle(fontSize: 12)),
                                Text(word.usPhone!, style: const TextStyle(fontSize: 12)),
                                const SizedBox(width: 16),
                              ],
                              if (word.ukPhone != null) ...[
                                const Text('è‹±éŸ³: ', style: TextStyle(fontSize: 12)),
                                Text(word.ukPhone!, style: const TextStyle(fontSize: 12)),
                              ],
                            ],
                          ),
                          const SizedBox(height: 8),
                        ],

                        Text(
                          'å•è¯è¯¦æƒ…æš‚æ—¶æ— æ³•å®Œå…¨æ˜¾ç¤º',
                          style: const TextStyle(color: Colors.orange, fontSize: 12),
                        ),

                        // æ˜¾ç¤ºä¸»è¦é‡Šä¹‰
                        if (word.trans.isNotEmpty) ...[
                          const SizedBox(height: 8),
                          Text(
                            'é‡Šä¹‰: ${word.trans.first.tranCn}',
                            style: const TextStyle(fontSize: 14),
                          ),
                        ],
                      ],
                    ),
                  ),
                ),

                const SizedBox(height: 16),

                // è°ƒè¯•ä¿¡æ¯ï¼ˆä»…debugæ¨¡å¼ï¼‰
                if (kDebugMode)
                  Card(
                    child: Padding(
                      padding: const EdgeInsets.all(DesignTokens.spacingSmall),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'è°ƒè¯•ä¿¡æ¯',
                            style: TextStyle(
                              fontSize: 12,
                              fontWeight: FontWeight.bold,
                              color: Colors.grey[600],
                            ),
                          ),
                          Text('ID: ${word.id}', style: const TextStyle(fontSize: 10)),
                          Text('WordId: ${word.wordId}', style: const TextStyle(fontSize: 10)),
                          Text('é‡Šä¹‰æ•°é‡: ${word.trans.length}', style: const TextStyle(fontSize: 10)),
                          Text('ä¾‹å¥æ•°é‡: ${word.sentences.length}', style: const TextStyle(fontSize: 10)),
                        ],
                      ),
                    ),
                  ),
              ],
            ),
          ),
        );
      },
    );
  }

  /// è°ƒè¯•accesså•è¯é—®é¢˜
  void _debugAccessWord() async {
    print('ğŸ” å¼€å§‹è°ƒè¯•accesså•è¯é—®é¢˜');
    print('ğŸ” wordId: ${widget.wordId}');

    try {
      // 1. æ£€æŸ¥wordByIdProvider
      final wordAsync = ref.read(wordByIdProvider(widget.wordId));
      print('ğŸ” wordAsyncçŠ¶æ€: ${wordAsync.runtimeType}');

      wordAsync.when(
        data: (word) {
          print('ğŸ” wordAsyncæ•°æ®: $word');
          if (word != null) {
            print('   - ID: ${word.id}');
            print('   - headWord: "${word.headWord}"');
            print('   - headWordé•¿åº¦: ${word.headWord.length}');
            print('   - usphone: "${word.usphone}"');
            print('   - ukphone: "${word.ukphone}"');
            print('   - transæ•°é‡: ${word.trans.length}');
            print('   - sentencesæ•°é‡: ${word.sentences.length}');
            print('   - phrasesæ•°é‡: ${word.phrases.length}');
          } else {
            print('âŒ wordAsyncæ•°æ®ä¸ºnull');
          }
        },
        loading: () {
          print('ğŸ” wordAsyncæ­£åœ¨åŠ è½½');
        },
        error: (error, stackTrace) {
          print('âŒ wordAsyncé”™è¯¯: $error');
          print('âŒ å †æ ˆè·Ÿè¸ª: $stackTrace');
        },
      );
    } catch (e) {
      print('âŒ è°ƒè¯•è¿‡ç¨‹å‡ºé”™: $e');
    }
  }

  /// æ„å»ºç®€åŒ–çš„å•è¯å¤´éƒ¨
  Widget _buildSimpleWordHeader(WordModel word) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(DesignTokens.spacingMedium),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          mainAxisSize: MainAxisSize.min,
          children: [
            // å•è¯æœ¬èº«
            Text(
              word.headWord ?? 'æœªçŸ¥å•è¯',
              style: Theme.of(context).textTheme.headlineMedium?.copyWith(
                fontWeight: FontWeight.bold,
                color: Theme.of(context).colorScheme.primary,
              ),
            ),
            const SizedBox(height: 8),

            // éŸ³æ ‡
            if (word.usPhone != null || word.ukPhone != null) ...[
              Wrap(
                children: [
                  if (word.usPhone != null) ...[
                    const Text('ç¾éŸ³: ', style: TextStyle(fontSize: 12)),
                    Text(word.usPhone!, style: const TextStyle(fontSize: 12)),
                    const SizedBox(width: 16),
                    // ç¾éŸ³æ’­æ”¾æŒ‰é’®
                    InkWell(
                      onTap: () => _playPronunciation(word.headWord, 'us'),
                      borderRadius: BorderRadius.circular(12),
                      child: const Padding(
                        padding: EdgeInsets.all(4),
                        child: Icon(Icons.volume_up, size: 16, color: Colors.blue),
                      ),
                    ),
                    const SizedBox(width: 16),
                  ],
                  if (word.ukPhone != null) ...[
                    const Text('è‹±éŸ³: ', style: TextStyle(fontSize: 12)),
                    Text(word.ukPhone!, style: const TextStyle(fontSize: 12)),
                    const SizedBox(width: 16),
                    // è‹±éŸ³æ’­æ”¾æŒ‰é’®
                    InkWell(
                      onTap: () => _playPronunciation(word.headWord, 'uk'),
                      borderRadius: BorderRadius.circular(12),
                      child: const Padding(
                        padding: EdgeInsets.all(4),
                        child: Icon(Icons.volume_up, size: 16, color: Colors.blue),
                      ),
                    ),
                  ],
                ],
              ),
            ],

            // ä¸»è¦é‡Šä¹‰
            if (word.trans.isNotEmpty) ...[
              const SizedBox(height: 12),
              Text(
                'é‡Šä¹‰: ${word.trans.map((t) => t.tranCn).join('ï¼›')}',
                style: const TextStyle(fontSize: 14),
              ),
            ],

            // ç®€å•åˆ†éš”çº¿
            const SizedBox(height: 8),
            const Divider(),
          ],
        ),
      ),
    );
  }

  /// æ’­æ”¾å•è¯å‘éŸ³
  void _playPronunciation(String word, String type) async {
    try {
      await _audioService.playWordPronunciation(word, type);

      // æ˜¾ç¤ºæ’­æ”¾æç¤º
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('æ­£åœ¨æ’­æ”¾ ${type == 'us' ? 'ç¾å¼' : 'è‹±å¼'} å‘éŸ³'),
            duration: const Duration(seconds: 1),
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('æ’­æ”¾å¤±è´¥: $e'),
            duration: const Duration(seconds: 2),
          ),
        );
      }
    }
  }

  /// æ„å»ºé”™è¯¯ç»„ä»¶
  Widget _buildErrorWidget(String title, String message) {
    return Center(
      child: Card(
        child: Padding(
          padding: const EdgeInsets.all(DesignTokens.spacingLarge),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              const Icon(Icons.error_outline, size: 48, color: Colors.red),
              const SizedBox(height: DesignTokens.spacingMedium),
              Text(title, style: Theme.of(context).textTheme.titleMedium),
              const SizedBox(height: DesignTokens.spacingSmall),
              Text(message, style: Theme.of(context).textTheme.bodyMedium),
              const SizedBox(height: DesignTokens.spacingMedium),
              ElevatedButton(
                onPressed: () {
                  Navigator.of(context).pop();
                },
                child: const Text('è¿”å›'),
              ),
            ],
          ),
        ),
      ),
    );
  }

  /// æ„å»ºåŠ è½½ç»„ä»¶
  Widget _buildLoadingWidget(String message) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const CircularProgressIndicator(),
          const SizedBox(height: DesignTokens.spacingMedium),
          Text(
            message,
            style: Theme.of(context).textTheme.bodyMedium,
          ),
        ],
      ),
    );
  }

  /// æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†
  void _showErrorDialog(BuildContext context, String error) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('æ¸²æŸ“é”™è¯¯'),
        content: SingleChildScrollView(
          child: Text(error),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('ç¡®å®š'),
          ),
        ],
      ),
    );
  }
}

/// PostFrameCallbackWrapper - ç¡®ä¿åœ¨ä¸‹ä¸€å¸§æ¸²æŸ“çš„åŒ…è£…ç»„ä»¶
class PostFrameCallbackWrapper extends StatefulWidget {
  final Widget Function() callback;
  final Widget fallback;

  const PostFrameCallbackWrapper({
    super.key,
    required this.callback,
    required this.fallback,
  });

  @override
  State<PostFrameCallbackWrapper> createState() => _PostFrameCallbackWrapperState();
}

class _PostFrameCallbackWrapperState extends State<PostFrameCallbackWrapper> {
  bool _hasRendered = false;

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (mounted && !_hasRendered) {
        setState(() {
          _hasRendered = true;
        });
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return _hasRendered ? widget.callback() : widget.fallback;
  }
}